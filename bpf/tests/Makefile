# Copyright Authors of Cilium
# SPDX-License-Identifier: (GPL-2.0-only OR BSD-2-Clause)

include ../../Makefile.defs

MAKEFLAGS += -r

CLANG ?= clang

FLAGS := -I$(ROOT_DIR)/bpf -I$(ROOT_DIR)/bpf/include -g

# Base CFLAGS (CLANG_FLAGS) are read from pkg/datapath/loader/compile.go
# to keep them synced with the loader
CLANG_FLAGS := $(FLAGS) $(shell $(GO) run $(ROOT_DIR)/pkg/datapath/loader/tools/clang_cflags.go)

# Create dependency files for each .o file.
CLANG_FLAGS += -MD

# Mimics the mcpu values set by cilium-agent. See GetBPFCPU().
ifneq ($(KERNEL),54)
CLANG_FLAGS += -mcpu=v3
else
CLANG_FLAGS += -mcpu=v2
endif

# Autogenerated scapy pkts
SCAPY_HDR := $(ROOT_DIR)/bpf/tests/output/gen_pkts.h
SCAPY_HDR_TS := $(ROOT_DIR)/bpf/tests/output/gen_pkts.h.stamp

.PHONY: all clean run $(SCAPY_HDR_TS)

TEST_OBJECTS = $(patsubst %.c, %.o, $(wildcard *.c))

all: $(TEST_OBJECTS)

$(SCAPY_HDR_TS):
	$(QUIET) $(ROOT_DIR)/bpf/tests/scapy/./parser.py . > $(SCAPY_HDR).tmp
	$(QUIET) if ! cmp -s $(SCAPY_HDR) $(SCAPY_HDR).tmp; then	\
		mv $(SCAPY_HDR).tmp $(SCAPY_HDR);			\
	else								\
		rm $(SCAPY_HDR).tmp;					\
	fi
	@touch $(SCAPY_HDR_TS)

$(SCAPY_HDR): $(SCAPY_HDR_TS)

%.o: %.c $(LIB) $(SCAPY_HDR)
	@$(ECHO_CC)
	@# Remove the .o file to force recompilation, only rely on make's caching, not clangs
	rm -f $@
	$(QUIET) ${CLANG} ${CLANG_FLAGS} -c $< -o $@

%.ll: %.c $(LIB)
	@$(ECHO_CC)
	$(QUIET) ${CLANG} ${CLANG_FLAGS} -c -emit-llvm $< -o $@

%.i: %.c $(LIB)
	@$(ECHO_CC)
	$(QUIET) ${CLANG} ${CLANG_FLAGS} -E -c $< -o $@


clean:
	rm -f output/*
	rm -f $(wildcard *.ll)
	rm -f $(wildcard *.o)
	rm -f $(wildcard *.i)
	rm -f $(wildcard *.d)

-include $(TEST_OBJECTS:.o=.d)
