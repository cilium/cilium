# This tests validates that LRP address matcher can overlap with a k8s
# service that has the same address as a frontend. On overlap the LRP
# address matcher wins. If the LRP is removed the k8s service is
# restored.
#

hive start

###
### Service before LRP
###

k8s/add service.yaml
db/cmp frontends frontends-before.table

# Now add the pod and LRP. The existing frontend from the service
# will be replaced by the LRP frontend and the original frontend is
# stored shadowed in the LRP frontend.
k8s/add pod.yaml lrp-addr.yaml
db/cmp frontends frontends-redirected.table

# Update the service to check that the change is remembered
# when the service is restored. Also add some backends to it.
sed 'name: tcp' 'name: http' service.yaml
k8s/update service.yaml
k8s/add endpointslice.yaml

# This should not affect the current frontend.
db/cmp frontends frontends-redirected.table

# Removing the LRP restores the original
k8s/delete lrp-addr.yaml

# Wait for frontend to change to the original
db/cmp frontends frontends-restored.table

# Cleanup
k8s/delete service.yaml pod.yaml lrp-addr.yaml

# Wait until empty
* db/empty frontends services localredirectpolicies

###
### LRP before Service
###

# Add the pod and redirect
k8s/add pod.yaml lrp-addr.yaml
db/cmp frontends frontends-redirected-no-shadow.table

# Adding the service will update the [Frontend.Redirect.Shadows]
k8s/add service.yaml endpointslice.yaml
db/cmp frontends frontends-redirected.table

# Removing the LRP will bring in the k8s frontend
k8s/delete pod.yaml lrp-addr.yaml
db/cmp frontends frontends-restored.table

# Add back the pod and redirect
k8s/add pod.yaml lrp-addr.yaml
db/cmp frontends frontends-redirected.table

# Removing the service will update the "shadows" and
# the frontend won't be incorrectly restored on LRP
# removal.
k8s/delete service.yaml endpointslice.yaml
db/cmp frontends frontends-redirected-no-shadow.table

# Removing the LRP will now remove all frontends.
k8s/delete pod.yaml lrp-addr.yaml

# Frontends should now be empty
db/show frontends
* db/empty frontends

# ---

-- frontends-before.table --
Address                   Type       ServiceName  PortName Redirect  Backends  Status
169.254.169.254:8080/TCP  ClusterIP  test/echo    tcp                          Done


-- frontends-redirected-no-shadow.table --
Address                   Type          ServiceName                   Redirect  Backends            Status
169.254.169.254:8080/TCP  LocalRedirect test/lrp-addr:local-redirect            10.244.2.1:80/TCP   Done

-- frontends-redirected.table --
Address                   Type          ServiceName                   Redirect              Backends            Status
169.254.169.254:8080/TCP  LocalRedirect test/lrp-addr:local-redirect  test/echo (shadows)   10.244.2.1:80/TCP   Done

-- frontends-restored.table --
Address                   Type       ServiceName  PortName Redirect Backends            Status
169.254.169.254:8080/TCP  ClusterIP  test/echo    http              10.244.1.1:8080/TCP Done

-- service.yaml --
apiVersion: v1
kind: Service
metadata:
  name: echo
  namespace: test
spec:
  clusterIP: 169.254.169.254
  clusterIPs:
  - 169.254.169.254
  externalTrafficPolicy: Cluster
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: DualStack
  ports:
  - name: tcp
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    name: echo
  sessionAffinity: None
  type: ClusterIP


-- endpointslice.yaml --
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  labels:
    kubernetes.io/service-name: echo
  name: echo-kvlm2
  namespace: test
addressType: IPv4
endpoints:
- addresses:
  - 10.244.1.1
  conditions:
    ready: true
    serving: true
    terminating: false
  nodeName: nodeport-worker
ports:
- name: http
  port: 8080
  protocol: TCP


-- lrp-addr.yaml --
apiVersion: "cilium.io/v2"
kind: CiliumLocalRedirectPolicy
metadata:
  name: "lrp-addr"
  namespace: "test"
spec:
  redirectFrontend:
    addressMatcher:
      ip: "169.254.169.254"
      toPorts:
        - port: "8080"
          protocol: TCP
  redirectBackend:
    localEndpointSelector:
      matchLabels:
        app: proxy
    toPorts:
      - port: "80"
        protocol: TCP

-- pod.yaml --
apiVersion: v1
kind: Pod
metadata:
  name: lrp-pod
  namespace: test
  labels:
    app: proxy
spec:
  containers:
    - name: lrp-pod
      image: nginx
      ports:
        - containerPort: 80
          name: tcp
          protocol: TCP
  nodeName: testnode
status:
  hostIP: 172.19.0.3
  hostIPs:
  - ip: 172.19.0.3
  phase: Running
  podIP: 10.244.2.1
  podIPs:
  - ip: 10.244.2.1
  conditions:
  - status: 'True'
    type: Ready
