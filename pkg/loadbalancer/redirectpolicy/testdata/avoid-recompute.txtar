# Test to check that pod changes that do not change the resulting redirect backends
# does not update the LB frontends and backends.

hive/start

# Add all inputs.
k8s/add service.yaml endpointslice.yaml lrp-svc.yaml pod.yaml
db/cmp localredirectpolicies lrp.table
db/cmp services services.table
db/cmp frontends frontends.table

db/show frontends -f yaml -o frontends-before.yaml

# Add another pod into the namespace of the redirect pod.
k8s/add pod2.yaml
sleep 100ms

# The frontend status.id should remain the same when
# recomputation is skipped.
db/show frontends -f yaml -o frontends-after.yaml
cmp frontends-before.yaml frontends-after.yaml
 
# -----

-- lrp-svc.yaml --
apiVersion: "cilium.io/v2"
kind: CiliumLocalRedirectPolicy
metadata:
  name: "lrp-svc"
  namespace: "test"
spec:
  redirectFrontend:
    serviceMatcher:
      serviceName: echo
      namespace: test
  redirectBackend:
    localEndpointSelector:
      matchLabels:
        app: proxy
    toPorts:
      - port: "80"
        name: "tcp"
        protocol: TCP

-- pod.yaml --
apiVersion: v1
kind: Pod
metadata:
  name: lrp-pod
  namespace: test
  labels:
    app: proxy
spec:
  containers:
    - name: lrp-pod
      image: nginx
      ports:
        - containerPort: 80
          name: tcp
          protocol: TCP
  nodeName: testnode
status:
  hostIP: 172.19.0.3
  hostIPs:
  - ip: 172.19.0.3
  phase: Running
  podIP: 10.244.2.1
  podIPs:
  - ip: 10.244.2.1
  - ip: 2001::1
  qosClass: BestEffort
  startTime: "2024-07-10T16:20:42Z"
  conditions:
  - lastProbeTime: null
    type: Ready
    status: "True"


-- pod2.yaml --
apiVersion: v1
kind: Pod
metadata:
  name: other-pod
  namespace: test
spec:
  containers:
    - name: nginx
      image: nginx
      ports:
        - containerPort: 80
          name: tcp
          protocol: TCP
  nodeName: testnode
status:
  hostIP: 172.19.0.3
  hostIPs:
  - ip: 172.19.0.3
  phase: Running
  podIP: 10.244.2.1
  podIPs:
  - ip: 10.244.2.1
  - ip: 2001::1
  qosClass: BestEffort
  startTime: "2024-07-10T16:20:42Z"
  conditions:
  - lastProbeTime: null
    type: Ready
    status: "True"

-- service.yaml --
apiVersion: v1
kind: Service
metadata:
  name: echo
  namespace: test
spec:
  clusterIP: 1.1.1.1
  clusterIPs:
  - 1.1.1.1
  - 1001::1
  externalTrafficPolicy: Cluster
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  - IPv6
  ipFamilyPolicy: DualStack
  ports:
  - name: tcp
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    name: echo
  sessionAffinity: None
  type: ClusterIP

-- endpointslice.yaml --
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  labels:
    kubernetes.io/service-name: echo
  name: echo-kvlm2
  namespace: test
addressType: IPv4
endpoints:
- addresses:
  - 10.244.1.1
  conditions:
    ready: true
    serving: true
    terminating: false
  nodeName: nodeport-worker
ports:
- name: tcp
  port: 8080
  protocol: TCP

-- lrp.table --
Name           Type     FrontendType                Frontends
test/lrp-svc   service  all

-- services-before.table --
Name                          Source
test/echo                     k8s   

-- services.table --
Name                          Source
test/echo                     k8s
test/lrp-svc:local-redirect   k8s   

-- frontends.table --
Address                  Type          ServiceName                  PortName   Backends              RedirectTo                    Status
1.1.1.1:8080/TCP         ClusterIP     test/echo                    tcp        10.244.2.1:80/TCP     test/lrp-svc:local-redirect   Done
[1001::1]:8080/TCP       ClusterIP     test/echo                    tcp        [2001::1]:80/TCP      test/lrp-svc:local-redirect   Done
