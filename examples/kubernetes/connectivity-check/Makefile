# Copyright 2017-2020 Authors of Cilium
# SPDX-License-Identifier: Apache-2.0

include ../../../Makefile.defs
include ../../../Makefile.quiet

DEFAULT_OUT := connectivity-check.yaml
HOSTPORT_OUT := connectivity-check-hostport.yaml
SINGLE_OUT := connectivity-check-single-node.yaml
PROXY_OUT := connectivity-check-proxy.yaml
QUARANTINE_OUT := connectivity-check-quarantine.yaml

SERVERS_NAME := echo-a echo-b echo-b-host echo-b-host-headless echo-c echo-c-host echo-c-host-headless
SERVERS_OUT := servers.yaml

SRC := $(wildcard *.cue)
ALL_TARGETS := $(DEFAULT_OUT) $(HOSTPORT_OUT) $(SINGLE_OUT) $(PROXY_OUT) $(QUARANTINE_OUT)

DOCKER_RUN := $(CONTAINER_ENGINE) container run --rm \
	--workdir /src/examples/kubernetes/connectivity-check \
	--volume $(CURDIR)/../../..:/src \
	--user "$(shell id -u):$(shell id -g)"

CUE_IMAGE := "docker.io/cuelang/cue:v0.2.2@sha256:2ea932c771212db140c9996c6fff1d236f3f84ae82add914374cee553b6fc60c"
CUE := $(DOCKER_RUN) $(CUE_IMAGE)

all: $(ALL_TARGETS)

$(DEFAULT_OUT): $(SRC)
	@echo '# Automatically generated by Makefile. DO NOT EDIT' > $(DEFAULT_OUT)
	$(QUIET)$(CUE) dump > $(DEFAULT_OUT)

$(HOSTPORT_OUT): $(SRC)
	@echo '# Automatically generated by Makefile. DO NOT EDIT' > $(HOSTPORT_OUT)
	$(QUIET)$(CUE) -t component=all dump > $(HOSTPORT_OUT)

$(SINGLE_OUT): $(SRC)
	@echo '# Automatically generated by Makefile. DO NOT EDIT' > $(SINGLE_OUT)
	$(QUIET)$(CUE) -t topology=single-node dump > $(SINGLE_OUT)

$(PROXY_OUT): $(SRC) $(SERVERS_OUT)
	@echo '# Automatically generated by Makefile. DO NOT EDIT' > $(PROXY_OUT)
	$(QUIET)$(CUE) -t component=proxy dump > $@
	@cat $(SERVERS_OUT) >> $@

$(QUARANTINE_OUT): $(SRC) $(SERVERS_OUT)
	@echo '# Automatically generated by Makefile. DO NOT EDIT' > $(QUARANTINE_OUT)
	$(QUIET)$(CUE) -t component=all -t quarantine=true dump > $@
	@cat $(SERVERS_OUT) >> $@

clean:
	@rm -f $(ALL_TARGETS)
	@rm -f *.new
	@rm -f *.diff
	@rm -f *.yaml

deploy:
	$(QUIET)kubectl apply -f connectivity-check-hostport.yaml

eval:
	$(QUIET)$(CUE) eval -c ./...

# To easier inspect individual yamls for specific checks, generate all YAMLs from *.cue
generate_all: $(SRC)
	# TODO: Don't run docker for every command
	@for deployment in $(shell $(CUE) -t component=all ls | tail -n+2 | awk '{ print $$4 }' | sort | uniq); do \
		$(CUE) -t component=all -t name=$$deployment dump > $$deployment.yaml; \
	done

inspect:
	@echo "Comparing latest cue declarations against cluster deployment from "make deploy"..."
	$(QUIET)$(CUE) -t component=all dump > connectivity-check-hostport.yaml.new
	-@kubectl diff -f connectivity-check-hostport.yaml.new > connectivity-check-hostport.yaml.diff
	@cat connectivity-check-hostport.yaml.diff
	@echo
	@echo "The full diff is available in connectivity-check-hostport.yaml.diff."

help:
	$(QUIET)$(CUE) cmd help

list:
	$(QUIET)$(CUE) cmd ls

$(SERVERS_OUT): $(SRC)
	@echo > $(SERVERS_OUT)
	@for name in $(SERVERS_NAME); do \
		$(CUE) cmd -t name=$$name dump >> $@; \
	done

.PHONY: all clean deploy eval generate_all help inspect list
