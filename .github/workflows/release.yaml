name: Release Tool

on:
  workflow_dispatch:
    inputs:
      step:
        description: 'Which step do you want to (re-)run?'
        required: true
        type: choice
        options:
          - 2-prepare-release
          - 4-post-release
          - 5-publish-helm
      version:
        description: 'Which version are you releasing? (e.g. vX.Y.Z[-(pre|rc).W])'
        required: true
        type: string
        default: vX.Y.Z

  workflow_call:
    inputs:
      step:
        description: 'Which step do you want to (re-)run?'
        required: true
        type: string
      version:
        description: 'Which version are you releasing? (e.g. vX.Y.Z[-(pre|rc).W])'
        required: true
        type: string
    secrets:
      CILIUM_RELEASE_BOT_PEM:
        required: true
      CILIUM_RELEASE_BOT_APP_ID:
        required: true
      QUAY_USERNAME_HELM_RELEASE_USERNAME:
        required: false
      QUAY_PASSWORD_HELM_RELEASE_PASSWORD:
        required: false

permissions:
  # To be able to access the repository with `actions/checkout`
  contents: read
  # Required to generate OIDC tokens for `sigstore/cosign-installer` authentication
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ inputs.version }}-${{ inputs.step }}
  cancel-in-progress: true

jobs:
  release:
    name: Release
    if: ${{ inputs.step != '5-publish-helm' }}
    environment: release-tool
    timeout-minutes: 40
    runs-on: ubuntu-24.04
    steps:
      - name: Install Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          # renovate: datasource=golang-version depName=go
          go-version: 1.25.6

      - name: Get token
        id: get_token
        uses: cilium/actions-app-token@61a6271ce92ba02f49bf81c755685d59fb25a59a # v0.21.1
        with:
          APP_PEM: ${{ secrets.CILIUM_RELEASE_BOT_PEM }}
          APP_ID: ${{ secrets.CILIUM_RELEASE_BOT_APP_ID }}

      - name: Authenticate with GH CLI
        run: |
          gh auth login --with-token <<< "${{ steps.get_token.outputs.app_token }}"

      - name: Checkout release tool
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          repository: cilium/release
          path: "./release"

      - name: Move release source code to upper directory
        run: mv release ../

      - name: Checkout cilium source code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.repository.default_branch }}
          persist-credentials: false

      - name: Build release tool
        shell: bash
        run: |
          cd ../release
          make

      - name: Set-up git
        run: |
          git config user.name "Cilium Release Bot"
          git config user.email "noreply@cilium.io"
          git remote set-url origin https://x-access-token:${{ steps.get_token.outputs.app_token }}@github.com/${{ github.repository }}.git

      - name: Run release tool
        shell: bash
        env:
          GITHUB_TOKEN: "${{ steps.get_token.outputs.app_token }}"
          ORG: "${{ github.repository_owner }}"
        run: |
          cd ../release
          ./release start \
            --force \
            --release-tool-dir "$(pwd)" \
            --charts-repo-dir "$(pwd)/../charts" \
            --repo-dir "$(pwd)/../cilium" \
            --repo ${{ github.repository }} \
            --target-version ${{ inputs.version }} \
            --steps ${{ inputs.step }} \
            --exclude-labels "cilium-cli-exclusive"

  release-helm:
    name: Release Helm
    if: ${{ inputs.step == '5-publish-helm' }}
    environment: release-helm
    timeout-minutes: 40
    runs-on: ubuntu-24.04
    steps:
      - name: Install Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          # renovate: datasource=golang-version depName=go
          go-version: 1.25.6

      - name: Install helm
        shell: bash
        run: |
          # We don't want renovate to update this version, because we want to
          # use a specific version of helm for the release tool to avoid
          # breaking the release process.
          HELM_VERSION=v3.18.5
          wget "https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz"
          tar -xf "helm-${HELM_VERSION}-linux-amd64.tar.gz"
          sudo mv ./linux-amd64/helm /usr/local/bin

      - name: Get token
        id: get_token
        uses: cilium/actions-app-token@61a6271ce92ba02f49bf81c755685d59fb25a59a # v0.21.1
        with:
          APP_PEM: ${{ secrets.CILIUM_RELEASE_BOT_PEM }}
          APP_ID: ${{ secrets.CILIUM_RELEASE_BOT_APP_ID }}

      - name: Authenticate with GH CLI
        run: |
          gh auth login --with-token <<< "${{ steps.get_token.outputs.app_token }}"

      - name: Checkout release tool
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          repository: cilium/release
          path: "./release"

      - name: Move release source code to upper directory
        run: mv release ../

      - name: Checkout helm chart
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          repository: cilium/charts
          path: "./cilium-charts"

      - name: Set up charts repository git configuration
        shell: bash
        run: |
          mv cilium-charts ../charts
          cd ../charts
          git config user.name "Cilium Release Bot"
          git config user.email "noreply@cilium.io"
          git remote set-url origin https://x-access-token:${{ steps.get_token.outputs.app_token }}@github.com/cilium/charts.git
          git remote set-head origin --auto

      - name: Checkout cilium source code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.repository.default_branch }}
          persist-credentials: false

      - name: Build release tool
        shell: bash
        run: |
          cd ../release
          make

      - name: Set-up git
        run: |
          git config user.name "Cilium Release Bot"
          git config user.email "noreply@cilium.io"
          git remote set-url origin https://x-access-token:${{ steps.get_token.outputs.app_token }}@github.com/${{ github.repository }}.git

      - name: Login to Helm registries
        shell: bash
        env:
          QUAY_USERNAME: ${{ secrets.QUAY_USERNAME_HELM_RELEASE_USERNAME }}
          QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD_HELM_RELEASE_PASSWORD }}
        run: |
          echo "Logging into Quay.io..."
          echo "${QUAY_PASSWORD}" | helm registry login quay.io --username "${QUAY_USERNAME}" --password-stdin

      - name: Run release tool
        shell: bash
        env:
          GITHUB_TOKEN: "${{ steps.get_token.outputs.app_token }}"
          ORG: "${{ github.repository_owner }}"
        run: |
          cd ../release
          ./release start \
            --force \
            --release-tool-dir "$(pwd)" \
            --charts-repo-dir "$(pwd)/../charts" \
            --repo-dir "$(pwd)/../cilium" \
            --repo ${{ github.repository }} \
            --target-version ${{ inputs.version }} \
            --steps ${{ inputs.step }} \
            --exclude-labels "cilium-cli-exclusive"

      - name: Wait for helm chart PR checks and merge
        shell: bash
        env:
          GITHUB_TOKEN: "${{ steps.get_token.outputs.app_token }}"
          VERSION: ${{ inputs.version }}
        run: |
          echo "ðŸ”„ Waiting for helm chart PR checks and merging for version $VERSION"

          # Find the PR for this release
          BRANCH="pr/prepare-$VERSION"
          echo "Looking for PR from branch: $BRANCH"

          # Wait for PR to exist (in case it was just created)
          MAX_WAIT=300  # 5 minutes
          WAIT_TIME=0
          PR_NUMBER=""

          while [ $WAIT_TIME -lt $MAX_WAIT ]; do
            PR_NUMBER=$(gh pr list --repo cilium/charts --head "$BRANCH" --state open --json number --jq '.[0].number // empty')
            if [ -n "$PR_NUMBER" ]; then
              echo "Found PR #$PR_NUMBER"
              break
            fi
            echo "Waiting for PR to be created..."
            sleep 10
            WAIT_TIME=$((WAIT_TIME + 10))
          done

          if [ -z "$PR_NUMBER" ]; then
            echo "âŒ No PR found for branch $BRANCH after waiting $MAX_WAIT seconds"
            echo "Available PRs:"
            gh pr list --repo cilium/charts --state open || echo "Failed to list PRs"
            exit 1
          fi

          echo "Merging PR #$PR_NUMBER..."
          MERGE_ATTEMPTS=0
          MAX_MERGE_ATTEMPTS=3
          MERGE_SUCCESS=false

          while [ $MERGE_ATTEMPTS -lt $MAX_MERGE_ATTEMPTS ]; do
            MERGE_ATTEMPTS=$((MERGE_ATTEMPTS + 1))
            echo "ðŸ”„ Attempt $MERGE_ATTEMPTS of $MAX_MERGE_ATTEMPTS"

            # Wait for checks to complete
            echo "â³ Waiting for PR checks to complete..."
            sleep 30  # Initial wait to allow checks to start
            if ! gh pr checks $PR_NUMBER --repo cilium/charts --fail-fast --required --watch; then
              echo "âŒ PR #$PR_NUMBER has failed checks on attempt $MERGE_ATTEMPTS"
              echo "ðŸ“‹ Failed workflow details:"
              gh pr checks $PR_NUMBER --repo cilium/charts --json name,state,link | jq -r '.[] | select(.state == "FAILURE") | "  - \(.name): \(.state) (\(.link // "No URL"))"'
              if [ $MERGE_ATTEMPTS -lt $MAX_MERGE_ATTEMPTS ]; then
                echo "âš ï¸ Retrying..."
                continue
              else
                exit 1
              fi
            fi

            echo "âœ… All required checks passed for PR #$PR_NUMBER"

            # Attempt to merge
            echo "Merging PR #$PR_NUMBER..."
            if gh pr merge $PR_NUMBER --repo cilium/charts --rebase --delete-branch; then
              echo "âœ… Successfully merged PR #$PR_NUMBER"
              MERGE_SUCCESS=true
              break
            else
              echo "âš ï¸ Merge attempt $MERGE_ATTEMPTS failed"
              if [ $MERGE_ATTEMPTS -lt $MAX_MERGE_ATTEMPTS ]; then
                echo "ðŸ”„ Re-running release tool to update PR..."

                # Reset the charts directory by removing any files
                # This is a workaround due to left overs made by the generate_helm_release.sh script
                echo "ðŸ§¹ Resetting ../charts directory..."
                cd ../charts
                git reset --hard HEAD
                git clean -fdx
                cd -

                # Re-run the release tool (step from line 127)
                cd ../release
                ./release start \
                  --force \
                  --release-tool-dir "$(pwd)" \
                  --charts-repo-dir "$(pwd)/../charts" \
                  --repo-dir "$(pwd)/../cilium" \
                  --repo ${{ github.repository }} \
                  --target-version $VERSION \
                  --steps ${{ inputs.step }} \
                  --exclude-labels "cilium-cli-exclusive"
                cd -
              else
                echo "âŒ Failed to merge PR #$PR_NUMBER after $MAX_MERGE_ATTEMPTS attempts"
                exit 1
              fi
            fi
          done

          if [ "$MERGE_SUCCESS" = false ]; then
            echo "âŒ Failed to merge PR #$PR_NUMBER after $MAX_MERGE_ATTEMPTS attempts"
            exit 1
          fi

      - name: Get Helm Chart Digests
        id: helm_digests
        shell: bash
        run: |
          # Extract version without 'v' prefix for Helm chart tag
          VERSION="${{ inputs.version }}"
          CHART_VERSION="${VERSION#v}"

          # Read digests from the file created by release tool
          DIGEST_FILE="../release/helm-digests-${CHART_VERSION}.txt"

          if [ ! -f "$DIGEST_FILE" ]; then
            echo "âŒ Digest file not found: $DIGEST_FILE"
            exit 1
          fi

          echo "â³ Reading digests from $DIGEST_FILE"
          cat "$DIGEST_FILE"

          # Extract digest for quay.io
          QUAY_DIGEST=$(grep "quay.io/cilium" "$DIGEST_FILE" | awk '{print $2}')
          echo "quay_digest=${QUAY_DIGEST}" >> $GITHUB_OUTPUT
          echo "âœ… Quay.io digest: ${QUAY_DIGEST}"

      - name: Sign quay.io OCI helm chart
        uses: ./.github/actions/cosign
        with:
          image: "quay.io/${{ github.repository_owner }}/charts/cilium@${{ steps.helm_digests.outputs.quay_digest }}"
          generate_sbom: 'false'
          attach_sbom: 'false'
          registry_username: ${{ secrets.QUAY_USERNAME_HELM_RELEASE_USERNAME }}
          registry_password: ${{ secrets.QUAY_PASSWORD_HELM_RELEASE_PASSWORD }}
          registry_url: 'quay.io'
