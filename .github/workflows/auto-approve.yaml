name: Approve Renovate PR

on:
  pull_request:
    types:
    - review_requested

jobs:
  pre-approve:
    # Avoid running the 'auto-approve' environment if we don't need to.
    name: Pre-Approve
    runs-on: ubuntu-24.04
    permissions: {}
    if: ${{
         github.event.pull_request.user.login == 'cilium-renovate[bot]' &&
         (github.triggering_actor == 'cilium-renovate[bot]' ||
          github.triggering_actor == 'auto-committer[bot]')
        }}
    steps:
    - name: Debug
      run: |
        echo ${{ github.event.pull_request.user.login }}
        echo ${{ github.triggering_actor }}
        echo ${{ github.event.requested_reviewer.login }}

  approve:
    name: Approve
    needs: pre-approve
    environment: auto-approve
    runs-on: ubuntu-24.04
    permissions: {}
    steps:
    - name: Debug
      run: |
        echo ${{ github.event.pull_request.user.login }}
        echo ${{ github.triggering_actor }}
        echo ${{ github.event.requested_reviewer.login }}

    - name: Approve PR
      # Approve the PR if all the following conditions are true:
      # - the PR was created by renovate bot and
      # - the PR review was requested by renovate bot or auto-committer[bot] and
      # - the requested reviewer was the trusted 'ciliumbot'
      if: ${{
           github.event.pull_request.user.login == 'cilium-renovate[bot]' &&
           (github.triggering_actor == 'cilium-renovate[bot]' ||
            github.triggering_actor == 'auto-committer[bot]')
          }}
      env:
        TOKEN: ${{ secrets.AUTO_APPROVE_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
      run: |
        echo ${TOKEN} | gh auth login --with-token
        gh -R ${GITHUB_REPOSITORY} pr review ${PULL_REQUEST_NUMBER} --approve

        # Check if ciliumbot was requested by cilium-renovate[bot] from the events list
        echo "Checking if ciliumbot was requested by cilium-renovate[bot]..."
        ciliumbot_requested_by_renovate=$(gh api "/repos/${GITHUB_REPOSITORY}/issues/${PULL_REQUEST_NUMBER}/events" --paginate --jq '[.[] | select(.event == "review_requested" and .requested_reviewer.login == "ciliumbot" and .actor.login == "cilium-renovate[bot]")] | length > 0')

        if [ "$ciliumbot_requested_by_renovate" == "true" ]; then
          echo "ciliumbot was requested by cilium-renovate[bot], removing other reviewers to avoid noise"
          reviewers=$(gh -R ${GITHUB_REPOSITORY} pr view ${PULL_REQUEST_NUMBER} --json reviewRequests --jq '.reviewRequests[] | select(."__typename"=="User") | .login')
          for reviewer in $reviewers; do
            if [ "$reviewer" != "ciliumbot" ]; then
              echo "Removing reviewer $reviewer"
              gh -R ${GITHUB_REPOSITORY} pr edit ${PULL_REQUEST_NUMBER} --remove-reviewer "$reviewer"
            fi
          done
        else
          echo "ciliumbot was not requested by cilium-renovate[bot], keeping all reviewers"
        fi
