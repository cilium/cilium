name: Cleanup GCE kops clusters

on:
  # Run every 3 hours
  # In case we leak kops cluster, we want to cleanup
  # 100 node cluster pretty fast
  schedule:
    - cron: '0 */3 * * *'

permissions:
  # To be able to access the repository with actions/checkout
  contents: read
  # To be able to request the JWT from GitHub's OIDC provider
  id-token: write
  # To allow retrieving information from the PR API
  pull-requests: read

concurrency:
  # Structure:
  # - Workflow name
  group: |
    ${{ github.workflow }}
  cancel-in-progress: true

env:
  # renovate: datasource=golang-version depName=go
  go_version: 1.25.6
  # renovate: datasource=docker depName=google/cloud-sdk
  gcloud_version: 554.0.0

jobs:
  cleanup-kops-clusters:
    runs-on: ubuntu-24.04
    name: Cleanup kops clusters
    timeout-minutes: 30
    steps:
      - name: Checkout context ref (trusted)
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.sha }}
          persist-credentials: false

      - name: Set Environment Variables
        uses: ./.github/actions/set-env-variables

      - name: Install Kops
        uses: cilium/scale-tests-action/install-kops@8535f579142fa598c3b2a895cfb248cd492d7c5a # main

      - name: Setup gcloud credentials
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
        with:
          workload_identity_provider: ${{ secrets.GCP_PERF_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_PERF_SA }}
          project_id: ${{ secrets.GCP_PERF_PROJECT_ID }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # v3.0.1
        with:
          version: ${{ env.gcloud_version }}

      - name: Cleanup stale clusters
        shell: bash
        timeout-minutes: 25
        run: |
          if ./kops get clusters --state ${{ secrets.GCP_PERF_KOPS_STATE_STORE }} -o json > /tmp/clusters.json
          then
            echo "Clusters list fetched successfully"
            date=$(date -u +%Y-%m-%d'T'%H:%M'Z' -d "3 hour ago")
            cat /tmp/clusters.json | jq -r --arg date "$date" '.[] | select(.metadata.creationTimestamp < $date) | .metadata.name' > /tmp/stale-clusters.txt
            # iterate through list of cluster names in /tmp/stale-clusters.txt
            while IFS= read -r cluster; do
              ./kops delete cluster --state ${{ secrets.GCP_PERF_KOPS_STATE_STORE }} $cluster --yes
            done < /tmp/stale-clusters.txt
          else
            echo "Failed to fetch clusters list, probably no clusters present"
          fi
