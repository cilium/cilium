name: Cilium Conn Disrupt Setup
description: Setup cilium connection disruption test

inputs:
  cilium-cli:
    required: false
    default: "/usr/local/bin/cilium"
    description: 'Path to the Cilium CLI binary'
  kernel:
    required: false
    default: ''
    description: 'Do not run NS conn distrupt tests for kernel 5.4'

runs:
  using: composite
  steps:
    - name: Setup Conn Disrupt Test
      shell: bash
      run: |
        # extract kernel version prefix
        version=${{ inputs.kernel }}
        version="${version%%-*}"

        include_ns_test=""
        if [[ "${version}" != "5.4" ]]; then
          include_ns_test="--include-conn-disrupt-test-ns-traffic"
        fi

        # Create pods which establish long lived connections. It will be used by
        # subsequent connectivity tests with --include-conn-disrupt-test to catch any
        # interruption in such flows.
        ${{ inputs.cilium-cli }} connectivity test --include-conn-disrupt-test \
          --include-conn-disrupt-test-egw \
          --include-unsafe-tests \
          --conn-disrupt-test-setup \
          --conn-disrupt-dispatch-interval 0ms \
          --conn-disrupt-test-restarts-path "./cilium-conn-disrupt-restarts" \
          --conn-disrupt-test-xfrm-errors-path "./cilium-conn-disrupt-xfrm-errors" \
          --expected-xfrm-errors "+inbound_no_state" $include_ns_test
