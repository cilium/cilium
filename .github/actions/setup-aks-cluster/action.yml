name: Create an AKS cluster
description: Create an AKS cluster
inputs:
  cluster_name:
    description: ''
    required: true
  location:
    description: ''
    required: true
  version:
    description: ''
    required: false
    default: ''
  node_count:
    description: ''
    required: false
    default: 2
  tags:
    description: ''
    required: false
    default: ''
  taints:
    description: ''
    required: false
    default: ''
runs:
  using: composite
  steps:
    - name: Get Runner IP
      id: get-runner-ip
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      with:
        script: |
          const net = require('net');
          const url = 'https://whatismyip.azurewebsites.net/json/';
          const res = await fetch(
            url, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json'
              }
            });

          if (!res.ok) {
            throw new Error(`Failed to fetch IP address: ${res.status} ${res.statusText}`);
          }

          const data = await res.json();
          const ip = data.ip;
          if (!net.isIP(ip)) {
            throw new Error(`Invalid IP address: ${ip}`);
          }

          return `${ip}/32`;

    - name: Create AKS cluster
      shell: bash
      run: |
        TAGS=""
        VERSION=""

        if [[ -n "${{ inputs.tags }}" ]]; then
          TAGS="--tags ${{ inputs.tags }}"
        fi

        if [[ -n "${{ inputs.version }}" ]]; then
          VERSION="--kubernetes-version ${{ inputs.version }}"
        fi

        # Create group
        az group create \
          --name ${{ inputs.cluster_name }} \
          --location ${{ inputs.location }} \
          $TAGS

        # Create AKS cluster
        az aks create \
          --resource-group ${{ inputs.cluster_name }} \
          --name ${{ inputs.cluster_name }} \
          --location ${{ inputs.location }} \
          $VERSION \
          --network-plugin none \
          --node-count ${{ inputs.node_count }} \
          --ip-families ipv4,ipv6 \
          ${{ inputs.taints }} \
          --generate-ssh-keys \
          --api-server-authorized-ip-ranges ${{ steps.get-runner-ip.outputs.result }}

