{{$scenario := .scenario}}

{{$namespaces := .namespaces}}
{{$tuningSet := .tuningSet}}

{{$deploymentsPerNamespace := .deploymentsPerNamespace}}
{{$clientInstancesPerDeployment := .clientInstancesPerDeployment}}

steps:
- name: Start measurement for perf clients
  measurements:
  - identifier: WaitForFinishedJobs
    method: WaitForFinishedJobs
    params:
      action: start
      labelSelector: app.kubernetes.io/name=http-perf-client

- name: Start perf client Jobs
  phases:
  - namespaceRange:
      min: 1
      max: {{$namespaces}}
    replicasPerNamespace: {{$deploymentsPerNamespace}}
    tuningSet: {{$tuningSet}}
    objectBundle:
    - basename: http-perf-client
      objectTemplatePath: ./manifests/perf-client.yaml
      templateFillMap:
        scenario: {{$scenario}}
        instances: {{$clientInstancesPerDeployment}}

- name: Wait for Perf Clients to finish
  measurements:
  - identifier: WaitForFinishedJobs
    method: WaitForFinishedJobs
    params:
      action: gather
      labelSelector: app.kubernetes.io/name=http-perf-client

- name: Clean up perf clients
  phases:
  - namespaceRange:
      min: 1
      max: {{$namespaces}}
    replicasPerNamespace: 0
    tuningSet: {{$tuningSet}}
    objectBundle:
    - basename: http-perf-client
      objectTemplatePath: ./manifests/perf-client.yaml
      templateFillMap:
        scenario: {{$scenario}}
        instances: {{$clientInstancesPerDeployment}}
