{{$TestImage := .CL2_EGW_TEST_IMAGE}}
{{$GatewayAddress := .CL2_EGW_GATEWAY_ADDRESS}}
{{$ExternalTarget := .CL2_EGW_EXTERNAL_TARGET}}

{{$NumEGWClients := DefaultParam .CL2_NUM_EGW_CLIENTS 9}}
{{$QPS := DefaultParam .CL2_EGW_CLIENTS_QPS 3}}
{{$CreateEGWPolicy := DefaultParam .CL2_EGW_CREATE_POLICY false}}
{{$EGWPolicyTemplate := DefaultParam .CL2_EGW_POLICY_TEMPLATE "manifests/egw-policy.yaml"}}

{{$ADDITIONAL_MEASUREMENT_MODULES := DefaultParam .CL2_ADDITIONAL_MEASUREMENT_MODULES nil}}

name: egw-scale-test-masq-delay
namespace:
  number: 1
  deleteAutomanagedNamespaces: false
tuningSets:
- name: Uniform1qps
  qpsLoad:
    qps: 1
- name: UniformParamqps
  qpsLoad:
    qps: {{$QPS}}
steps:
{{ if $CreateEGWPolicy }}
- name: Create Egress Gateway Policy
  phases:
  - replicasPerNamespace: 1
    tuningSet: Uniform1qps
    objectBundle:
    - basename: egw-scale-test-route-external
      objectTemplatePath: {{$EGWPolicyTemplate}}
      templateFillMap:
        ExternalTarget: {{$ExternalTarget}}
{{ end }}

- name: Create External Target Pod
  phases:
  - namespaceRange:
      min: 1
      max: 1
    replicasPerNamespace: 1
    tuningSet: Uniform1qps
    objectBundle:
    - basename: egw-external-target
      objectTemplatePath: manifests/external-target-pod.yaml
      templateFillMap:
        Image: {{$TestImage}}
        AllowedCIDR: {{ if $CreateEGWPolicy }}{{$GatewayAddress}}/32{{ else }}0.0.0.0/0{{ end }}

- name: Wait for external target pod to be running
  measurements:
  - Identifier: WaitForRunningPods
    Method: WaitForRunningPods
    Params:
      labelSelector: app.kubernetes.io/name=egw-external-target
      desiredPodCount: 1
      timeout: 60s
- name: Create bootstrap EGW client Pod
  phases:
  - namespaceRange:
      min: 1
      max: 1
    replicasPerNamespace: 1
    tuningSet: Uniform1qps
    objectBundle:
    - basename: egw-client-pod-bootstrap
      objectTemplatePath: manifests/client-pod.yaml
      templateFillMap:
        Image: {{$TestImage}}
        Instance: "bootstrap"
        ExternalTarget: {{$ExternalTarget}}
        ClientConnectTimeout: "60s"
- name: Wait for EGW bootstrap pod to be running
  measurements:
  - Identifier: WaitForRunningPods
    Method: WaitForRunningPods
    Params:
      labelSelector: app.kubernetes.io/name=egw-client,app.kubernetes.io/instance=bootstrap
      desiredPodCount: 1
      timeout: 55s

{{if $ADDITIONAL_MEASUREMENT_MODULES}}
{{range $ADDITIONAL_MEASUREMENT_MODULES}}
- module:
    path: {{.}}
    params:
      action: start
{{end}}
{{end}}

- module:
    path: modules/masq-test.yaml
    params:
      image: {{$TestImage}}
      instance: test-1
      externalTarget: {{$ExternalTarget}}
      replicas: {{$NumEGWClients}}

{{if $ADDITIONAL_MEASUREMENT_MODULES}}
{{range $ADDITIONAL_MEASUREMENT_MODULES}}
- module:
    path: {{.}}
    params:
      action: gather
{{end}}
{{end}}
