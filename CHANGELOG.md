# Changelog

## v1.13.0-rc5

Summary of Changes
------------------

**Major Changes:**
* cilium: completion of nat46/64 gateway (Backport PR #22948, Upstream PR #22421, @borkmann)
* Support Kubernetes v1.21 new field internalTrafficPolicy=Local. (Backport PR #23001, Upstream PR #21871, @gentoo-root)

**Minor Changes:**
* Bump Linux minimum version to 4.19.57 (or equivalent) (Backport PR #23232, Upstream PR #23124, @joestringer)
* feat(hubble): add L7 verdicts to hubble_policy_verdicts_total metric (Backport PR #23147, Upstream PR #22622, @raphink)
* Fix crash of CES queue delay metric when CESTracker is nil (Backport PR #23147, Upstream PR #22884, @dlapcevic)
* helm: Add  `node-role.kubernetes.io/control-plane` key (Backport PR #23001, Upstream PR #22893, @my-git9)
* operator: Add RBAC permission for CiliumNodeConfigs resource (Backport PR #23001, Upstream PR #22824, @sayboras)
* pkg/metrics: include revision and arch info in cilium_version (Backport PR #23147, Upstream PR #22795, @ArthurChiao)

**Bugfixes:**
* bpf: lb: catch write error in lb6_xlate() (Backport PR #23147, Upstream PR #23075, @julianwiedmann)
* bpf: lb: fix check for L3 pseudo-hdr csum update in lb6_xlate() (Backport PR #23001, Upstream PR #22953, @julianwiedmann)
* bpf: nodeport: fix tracing for handle_nat_fwd() (Backport PR #23001, Upstream PR #22678, @julianwiedmann)
* bpf: nodeport: handle revDNAT for local backends at to-netdev/to-overlay (Backport PR #23232, Upstream PR #22756, @julianwiedmann)
* clustermesh: Add missing brackets of IPv6 address for etcd option (Backport PR #23147, Upstream PR #22962, @YutaroHayakawa)
* daemon: Fix BPF host routing can't be enabled if the devices are wildcard (Backport PR #23232, Upstream PR #23009, @ysksuzuki)
* datapath: Fix L7 ingress with XDP (Backport PR #23147, Upstream PR #22985, @brb)
* envoy: Fix lock leak in config validation failure (Backport PR #23147, Upstream PR #23077, @joestringer)
* Fix bugs where ciliumendpoints for statefulset pods where being incorrectly overwritten/deleted (Backport PR #23147, Upstream PR #21768, @tommyp1ckles)
* Fix double-accounted RX packets in CT statistics when Nodeport is in use. (Backport PR #23147, Upstream PR #22810, @julianwiedmann)
* Fix missing node neigh metric for counting arping requests (Backport PR #23001, Upstream PR #22930, @christarazi)
* Fix packet drops when service pod connects to itself via clusterIP, and selected by an ingress policy. (Backport PR #23147, Upstream PR #22972, @aditighag)
* Fix socket-lb tracing in environments with systemd and container runtimes like containerd, crio, and docker. (Backport PR #23001, Upstream PR #22773, @aditighag)
* ingress/model: Support multiple certs based on SNI (Backport PR #23232, Upstream PR #22671, @sayboras)

**CI Changes:**
* .github: Pin docker buildx version to v0.9.1 (v2) (Backport PR #23233, Upstream PR #23220, @joestringer)
* [v1.13] ci: update cilium-cli to v0.12.12 in v1.13 workflows (#23129, @tklauser)
* bpf: test: fix xdp_lb4_forward_to_other_node test (Backport PR #23147, Upstream PR #23018, @julianwiedmann)
* ctmap: fix-up host_local flag in the DSR NAT entry for GC test (Backport PR #23147, Upstream PR #23037, @julianwiedmann)
* gh/workflows: ci-datapath updates (Backport PR #23147, Upstream PR #22811, @brb)
* gh/workflows: Extend ci-datapath config to include lb-mode and endpoint-routes (Backport PR #23147, Upstream PR #22825, @brb)
* gha: Pin minikube version used in CI (Backport PR #23232, Upstream PR #23099, @sayboras)
* per-node config improvements: testing, null selector, cleanups (Backport PR #23147, Upstream PR #22950, @squeed)
* test/l4lb,nat46x64: Replace Kind/Helm with DinD (Backport PR #23242, Upstream PR #22653, @brb)
* test: Quarantine TLS test for now (Backport PR #23001, Upstream PR #22684, @jrajahalme)
* workflows: fix skip condition for encryption tests in datapath conformance (Backport PR #23001, Upstream PR #22763, @tklauser)

**Misc Changes:**
* Add Cilium configuration documentation (Backport PR #23001, Upstream PR #22744, @squeed)
* bpf: fix cb collision for nat46x64 (Backport PR #22948, Upstream PR #23012, @borkmann)
* bpf: lb: fix L3 pseudo-hdr csum update for SCTP in __lb6_rev_nat() (Backport PR #23147, Upstream PR #23063, @julianwiedmann)
* bpf: nodeport: fix-up error check in rev_nodeport_lb*() for XDP (Backport PR #23147, Upstream PR #23119, @julianwiedmann)
* bpf: nodeport: NAT64 cleanups (Backport PR #22948, Upstream PR #22915, @julianwiedmann)
* bpf: nodeport: reset EDT aggregate ID for XDP-to-TC tunnel punt (Backport PR #23147, Upstream PR #23029, @julianwiedmann)
* bpf: Relax constant check for dst_id for clang 14+ (Backport PR #23147, Upstream PR #22919, @sayboras)
* build(deps): bump actions/cache from 3.2.0 to 3.2.3 (#22992, @dependabot[bot])
* build(deps): bump actions/download-artifact from 3.0.1 to 3.0.2 (#22961, @dependabot[bot])
* build(deps): bump docker/build-push-action from 3.2.0 to 3.3.0 (#23116, @dependabot[bot])
* build(deps): bump github/codeql-action from 2.1.37 to 2.1.38 (#23073, @dependabot[bot])
* build(deps): bump github/codeql-action from 2.1.38 to 2.1.39 (#23191, @dependabot[bot])
* build(deps): bump golangci/golangci-lint-action from 3.3.1 to 3.4.0 (#23253, @dependabot[bot])
* build(deps): update package dependencies (Backport PR #23232, Upstream PR #23140, @fengshunli)
* build: Avoid re-building when building docs from the main Makefile (Backport PR #23147, Upstream PR #22979, @jrajahalme)
* build: Bump base image build time for SBOM (Backport PR #23233, Upstream PR #23148, @joestringer)
* Change start time for policy_implementation_delay to when a CNP is first received by the Agent (Backport PR #23001, Upstream PR #22503, @learnitall)
* chore(deps): update docker.io/library/golang docker tag to v1.19.5 (v1.13) (#23243, @renovate[bot])
* chore(deps): update docker.io/library/golang docker tag to v1.19.5 (v1.13) (#23244, @renovate[bot])
* ci, github: Fix IPv6 conformance test (Backport PR #23001, Upstream PR #22774, @borkmann)
* ci: extend nat46x64 l4lb test suite (Backport PR #23242, Upstream PR #23020, @borkmann)
* cilium: follow-up neigh fixes for gw (Backport PR #22948, Upstream PR #22814, @borkmann)
* datapath: Get rid of NO_REDIRECT define (Backport PR #23147, Upstream PR #23076, @brb)
* docs: Add install guide for deploying Cilium on K0s using k0sctl. (Backport PR #23001, Upstream PR #22029, @xinity)
* docs: Document internalTrafficPolicy-related changes in the upgrade guide (Backport PR #23001, Upstream PR #22927, @gentoo-root)
* docs: Fix inconsistent node label in egress gateway guide (Backport PR #23232, Upstream PR #23225, @pchaigno)
* docs: Fix markup to properly emphasize Kubernetes version in a note (Backport PR #23001, Upstream PR #22976, @Shunpoco)
* docs: Improve IPsec guide (Backport PR #23232, Upstream PR #23135, @pchaigno)
* docs: Improve wording for deny policies limitation (Backport PR #23232, Upstream PR #23095, @joestringer)
* docs: Mark pod-short option in Hubble metrics as deprecated (Backport PR #23232, Upstream PR #23025, @lambdanis)
* docs: move star wars demo to getting started (Backport PR #23147, Upstream PR #22379, @yoyo-go)
* docs: update committer security requirements (Backport PR #23232, Upstream PR #23134, @xmulligan)
* docs: Update Minikube ver. requirement and manual BPFFS mount instructions (Backport PR #23232, Upstream PR #22913, @kimstacy)
* Document socket LB tracing (Backport PR #23232, Upstream PR #23141, @aditighag)
* Fix issues with policy handling introduced by new policy match support for L4 ports on any protocol. (Backport PR #23232, Upstream PR #22975, @jrajahalme)
* Generate Software Bill of Materials during release (Backport PR #23147, Upstream PR #22191, @sandipanpanda)
* gh: fix indentation bug in ingress workflows (Backport PR #23232, Upstream PR #23195, @julianwiedmann)
* gha: Bump k8s version in kind conformance tests (Backport PR #23147, Upstream PR #22325, @sayboras)
* gha: Improve coverage for Ingress/GatewayAPI (Backport PR #23147, Upstream PR #23007, @sayboras)
* github: do not generate SBOM from source (Backport PR #23233, Upstream PR #23161, @aanm)
* hubble: Fix panic if IP address cannot be parsed (Backport PR #23147, Upstream PR #22994, @gandro)
* hubble: Update the reason label for hubble_drop_total metric (Backport PR #23232, Upstream PR #22408, @michi-covalent)
* images/runtime: bump iptables package to 1.8.8 (Backport PR #23232, Upstream PR #23163, @jibi)
* images: Update Hubble CLI to v0.11.0 (Backport PR #23147, Upstream PR #23043, @gandro)
* Improve fqdn events logging management (Backport PR #23001, Upstream PR #22745, @pippolo84)
* IPsec: Refactor `ipSecReplaceState{In,Out}` functions (Backport PR #23232, Upstream PR #23158, @pchaigno)
* iptables: skip reverse IP lookup (Backport PR #23147, Upstream PR #22977, @jibi)
* k8s: Add node-role.kubernetes.io/control-plane taint (Backport PR #23147, Upstream PR #22894, @sayboras)
* k8s: Update dependencies to v0.26.0 (Backport PR #23001, Upstream PR #22891, @sayboras)
* Make cilium pprof listen address configurable (Backport PR #23147, Upstream PR #22768, @chancez)
* pkg/maps,pkg/defaults: allow configuring map events on missing map types. (Backport PR #23001, Upstream PR #22746, @tommyp1ckles)
* refactoring of fetching cilium manifests in OKD installation (Backport PR #23232, Upstream PR #22695, @zisisli)

**Other Changes:**
* install: Update image digests for v1.13.0-rc4 (#22852, @joestringer)

## v1.13.0-rc4

Summary of Changes
------------------

**Major Changes:**
* Add per-node configuration overrides. There is a new Kubernetes resource type, CiliumNodeConfig, which allows for fine-grained configuration of Nodes based on label selectors. (Backport PR #22822, Upstream PR #22656, @squeed)
* Added capability to announce LoadBalancer services via BGP Control Plane (#22397, @dylandreimerink)
* CiliumNetworkPolicy now supports enforcement of SNI in TLS connections. (#22398, @jrajahalme)

**Minor Changes:**
* Add option to configure the resources of the cgroups automount init Container in the Cilium Agent DaemonSet. (#22384, @shaardie)
* Added 'envoy.filters.http.jwt_authn' and 'envoy.filters.http.oauth2' to the build to be used in CiliumEnvoyConfig resources. (#22562, @jrajahalme)
* bpf: nat: fix usage of ipv6_hdrlen() with unhandled Extension headers (#22544, @julianwiedmann)
* Bugtool: add flag to exclude object for endpoints (#22370, @tbalthazar)
* cilium: Add deprecation warning for service ids (Backport PR #22822, Upstream PR #22700, @joamaki)
* clustermesh: Add an infrastructure to connect time parameter exchange and capability negotiation (Backport PR #22822, Upstream PR #22553, @YutaroHayakawa)
* egressgw: drop support for CiliumEgressNATPolicy (#21874, @julianwiedmann)
* envoy: Support LB capability for existing k8s Service (Backport PR #22835, Upstream PR #21244, @sayboras)
* helm: Support configuring Cilium shared Ingress Service type and nodePorts (#22583, @chancez)
* install/kubernetes: make securityContext SELinux options configurable (Backport PR #22822, Upstream PR #22721, @tklauser)
* Load multiple programs for one CollectionSpec loading (#22025, @alexkats)
* Remove deprecated `spec.eni.{min-allocate,pre-allocate,max-above-watermark}` parameters (#21951, @obaranov1)
* Traffic can now we redirected to Envoy listeners via Cilium Network Policy `listener` option. (Backport PR #22822, Upstream PR #21600, @jrajahalme)

**Bugfixes:**
* bpf: add drop notification for missed L7 LB tailcall in to-netdev (Backport PR #22822, Upstream PR #22679, @julianwiedmann)
* bpf: nodeport: fix drop notification in IPv6 revNAT (#22543, @julianwiedmann)
* bpf: nodeport: wire up trace aggregation for rev_nodeport_lb6() (Backport PR #22835, Upstream PR #22794, @julianwiedmann)
* daemon: Do not remove PERM L2 entries in L4LB (Backport PR #22822, Upstream PR #22676, @brb)
* Do not let the bandwidth manager decrease existing sysctl values. (#22468, @ArthurChiao)
* Fix a data race in dnsproxy which could lead to DNS requests drops. (Backport PR #22822, Upstream PR #22619, @aspsk)
* Fix bug that caused ingress policies to be enforced twice when running with tunneling and endpoint routes. (Backport PR #22822, Upstream PR #22333, @pchaigno)
* Fix race condition in DNS proxy when multiple DNS requests for the same name end up with policy drops, even though the traffic is allowed (Backport PR #22822, Upstream PR #22252, @christarazi)
* Fixes `semaphore_rejected_total` metric and adds new `scope` to `proxy_upstream_reply_seconds` metric. (#21267, @rahulkjoshi)
* Improve garbage collection for FQDNs particularly with high-churn IP names such as Amazon S3. (#22510, @joestringer)
* ipam/crd: Fix router initialization fatal when ENI data race happens (Backport PR #22822, Upstream PR #22477, @jaffcheng)

**CI Changes:**
* .github/workflows: bump ubuntu version for code-ql (#22505, @aanm)
* .github: add debug for codeql (#22607, @aanm)
* ci: Replace deprecated `hubble observe -o json` with `-o jsonpb` (Backport PR #22822, Upstream PR #22796, @gandro)
* ci: update cilium-cli to v0.12.11 for master, v1.11 and v1.12 workflows (#22494, @tklauser)
* contrib/scripts: Add check for use of viper's default instance (#22445, @joamaki)
* daemon/cmd: improve stale cilium endpoint error handling. (Backport PR #22822, Upstream PR #22600, @tommyp1ckles)
* dependabot: monthly update of cloud provider SDK Go modules (#22489, @tklauser)
* Fix when install k8s-1.25 ,no need cni install (#22355, @yanggangtony)
* gh/workflows: Add DP CI for encryption (Backport PR #22822, Upstream PR #22418, @brb)
* gh/workflows: tune LVH VM params (#22425, @brb)
* gha: Add retry mechanism for conformance ingress (shared) (Backport PR #22822, Upstream PR #22673, @sayboras)
* Revert "dependabot: monthly update of cloud provider SDK Go modules" (#22571, @pippolo84)
* test/helpers: Fix retry condition for CiliumExecContext (Backport PR #22822, Upstream PR #22726, @christarazi)
* test/l4lb, nat64x46: pass k8s api server to the standalone proxy (Backport PR #22822, Upstream PR #22627, @squeed)
* test: Keep trying exec if killed (#22570, @jrajahalme)
* test: service: fix formatting of error msg in doFragmentedRequest() (Backport PR #22822, Upstream PR #22772, @julianwiedmann)
* test: Speify `test/k8s` directory on `k8s_install.sh` to modify pulling images (#22530, @Shunpoco)
* workflow: disable tests pod-to-world and pod-to-cidr (#22475, @brlbil)
* workflow: Reenable IPsec tests in EKS for v1.12 (#22618, @pchaigno)
* workflow: Workaround EKS flake (#22590, @pchaigno)
* workflows: add wait for no operation for cleaning up GKE (#22350, @brlbil)
* workflows: Collect a final sysdump on AKS (#22537, @pchaigno)
* workflows: Collect sysdumps on failures (#22538, @pchaigno)
* workflows: Reduce verbosity of connectivity tests (#22605, @pchaigno)
* workflows: Reduce verbosity of connectivity tests on AKS (#22536, @pchaigno)

**Misc Changes:**
* .github/workflows: print author association (#22606, @aanm)
* .github/workflows: use right event type for auto labeler (#22508, @aanm)
* .github: add PR labeler for external contributions (#22461, @aanm)
* Add --pprof-debug args to cilium-bugtool (#22282, @yanggangtony)
* Add per-node configuration overrides. There is a new Kubernetes resource type, CiliumNodeConfig, which allows for fine-grained configuration of Nodes based on label selectors. (#22163, @squeed)
* Add sphinxcontrib-googleanalytics to doc requirements (Backport PR #22822, Upstream PR #22821, @chalin)
* Add tests for hubble metrics handlers (Backport PR #22822, Upstream PR #22518, @marqc)
* backporting: leave `backport/author` PRs alone (Backport PR #22822, Upstream PR #22654, @bimmlerd)
* bpf_sockops string constant can use const eSockops replace (#22490, @tanberBro)
* build(deps): bump actions/cache from 3.0.11 to 3.2.0 (#22843, @dependabot[bot])
* build(deps): bump actions/setup-go from 3.3.1 to 3.4.0 (#22483, @dependabot[bot])
* build(deps): bump actions/setup-go from 3.4.0 to 3.5.0 (#22718, @dependabot[bot])
* build(deps): bump actions/stale from 5.1.1 to 6.0.1 (#22499, @dependabot[bot])
* build(deps): bump github.com/go-openapi/runtime from 0.24.2 to 0.25.0 (#22413, @dependabot[bot])
* build(deps): bump github.com/hashicorp/consul/api from 1.17.0 to 1.18.0 (#22549, @dependabot[bot])
* build(deps): bump github.com/onsi/gomega from 1.23.0 to 1.24.1 (#22391, @dependabot[bot])
* build(deps): bump github.com/tidwall/gjson from 1.14.3 to 1.14.4 (#22395, @dependabot[bot])
* build(deps): bump github/codeql-action from 2.1.32 to 2.1.35 (#22498, @dependabot[bot])
* build(deps): bump github/codeql-action from 2.1.35 to 2.1.36 (#22633, @dependabot[bot])
* build(deps): bump github/codeql-action from 2.1.36 to 2.1.37 (#22736, @dependabot[bot])
* build(deps): bump go.opentelemetry.io/otel from 1.11.1 to 1.11.2 (#22621, @dependabot[bot])
* build(deps): bump golang.org/x/sys from 0.2.0 to 0.3.0 (#22548, @dependabot[bot])
* build(deps): bump helm/kind-action from 1.4.0 to 1.5.0 (#22720, @dependabot[bot])
* build(deps): bump KyleMayes/install-llvm-action from 1.6.0 to 1.6.1 (#22592, @dependabot[bot])
* chore(deps): update base-images (v1.13) (#22647, @renovate[bot])
* chore(deps): update docker.io/library/alpine docker tag to v3.17.0 (master) (#22317, @renovate[bot])
* chore(deps): update docker.io/library/golang:1.19.3 docker digest to 10e3c0f (master) (#22566, @renovate[bot])
* chore(deps): update docker.io/library/ubuntu:22.04 docker digest to 27cb6e6 (v1.13) (#22661, @renovate[bot])
* contrib: exclude non-running pods in k8s-unmanaged script (#22515, @felfa01)
* contributing: Document CNCF DCO Guidelines v1.0 (#22509, @joestringer)
* daemon: Close the identityAllocator on shutdown (#22411, @joestringer)
* daemon: Do not fail CI runs for already deleted CEP (#22474, @jrajahalme)
* delete redundant type conversion (#22376, @tanberBro)
* Docs: Replace the way to install `golangci-lint` to `NA(OS-specific)` (#22532, @Shunpoco)
* docs: restructure bpf guide (#21922, @yoyo-go)
* docs: update cmdref with missing flag (#22525, @aanm)
* document helm conntrackGCInterval crdWaitTimeout identityChangeGracePeriod (#22352, @vincentmli)
* Enable Google Analytics 4 (Backport PR #22835, Upstream PR #22220, @chalin)
* envoy: Skip NPHDS upsert when IP is already included (#22289, @jrajahalme)
* examples: Add Envoy admin listener (#22386, @jrajahalme)
* Fix long-time failure of "ipcache-inject-labels" controller due to incorrect backoff time for retry (#21886, @ArthurChiao)
* Fix note for 'func numWorkerThreads()' (#22412, @yanggangtony)
* Fix prepare release process (#22487, @aanm)
* fix:omit comparison to bool constant (#22588, @yulng)
* fix:remove ioutil to accomodate newer Go versions (#22383, @yulng)
* fuzzing: bump go-fuzz-headers (#22501, @AdamKorcz)
* go.mod, vendor: drop client-go from replace directives (#22547, @tklauser)
* go.mod, vendor: update cloud provider SDK Go modules for December 2022 (#22469, @tklauser)
* hive: Allow multiple calls to `Hive.Shutdown` (#22551, @dylandreimerink)
* hubble/metrics: ProcessFlow() is optional for metrics handlers (#20367, @chancez)
* Initial datapath support for Cilium mTLS has been added. (Backport PR #22822, Upstream PR #21822, @jrajahalme)
* Introduce v3 backend maps (Backport PR #22822, Upstream PR #21797, @YutaroHayakawa)
* ipcache: Fix IPcache leak of remote-node IP addresses (#21932, @pchaigno)
* Keep command help message capital (#22276, @yanggangtony)
* modify the deprecated label beta.kubernetes.io/instance-type (#21941, @my-git9)
* operator: Remove use of global vars in cilium node synchronizer (#22491, @joamaki)
* operator: Wait for informers to shut down when stopping (Backport PR #22835, Upstream PR #22761, @joamaki)
* pkg: Follow Go convention on capitalization (#22534, @yulng)
* Prepare for release v1.13.0-rc3 (#22481, @aanm)
* Prepare v1.13 stable branch (#22612, @joestringer)
* Remove unnecessary imports of pkg/policy (#21996, @jrajahalme)
* Revert "Mount host /boot into cilium-agent container" (#22326, @ti-mo)
* Revert "per-node configuration overrides" pull request (#22630, @pchaigno)
* support reset backoff period (#21937, @wu0407)
* test/control-plane: Add nil check for agentHandle.Close receiver (#22399, @dylandreimerink)
* Update Cilium install guide about EKS aws-node DaemonSet potential connectivity problem on uninstall (#22620, @NikAleksandrov)
* Update Go to 1.19.4 (#22589, @tklauser)
* update gops and ginkgo mod version for match the current go.mod (#22427, @yanggangtony)
* Update Layer 7 Protocol Visibility Document. (Backport PR #22835, Upstream PR #22807, @obaranov1)
* util: fix wrong comment of GetNumPossibleCPUs (#22540, @117503445)

**Other Changes:**
* build(deps): bump certifi from 2022.6.15 to 2022.12.7 in /Documentation (#22609, @dependabot[bot])
