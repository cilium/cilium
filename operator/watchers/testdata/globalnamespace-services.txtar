#! --cluster-id=3 --cluster-name=cluster3 --clustermesh-default-global-namespace=false

hive/start

# Add two namespaces - ns-alpha (annotated as global), ns-beta (not global)
k8s/add namespace-alpha.yaml namespace-beta.yaml

# Add two services with shared annotation - one in each namespace
k8s/add service-alpha.yaml service-beta.yaml

# Add endpoint slices for the services
k8s/add endpointslice-alpha.yaml endpointslice-beta.yaml

# Assert that the synced key gets created
kvstore/list -o plain cilium/synced synced.actual
* grep -q '^# cilium/synced/cluster3/cilium/state/services/v1$' synced.actual

# Wait for synchronization. Only service in ns-alpha should be synced (global namespace)
# The service in ns-beta should NOT be synced even though it has the service.cilium.io/shared annotation
kvstore/list -o json cilium/state/services services-1.actual
* cmp services-1.actual services-1.expected

# Annotate ns-beta as global
k8s/update namespace-beta-annotated.yaml

# Wait for synchronization. Now both services should be synced
kvstore/list -o json cilium/state/services services-1+2.actual
* cmp services-1+2.actual services-1+2.expected

# Remove global annotation from ns-beta
k8s/update namespace-beta.yaml

# Wait for synchronization. Only service in ns-alpha should remain synced
kvstore/list -o json cilium/state/services services-1.actual
* cmp services-1.actual services-1.expected

# Delete the service in ns-alpha
k8s/delete service-alpha.yaml

# Wait for synchronization. No services should remain synced
kvstore/list -o json cilium/state/services services-empty.actual
* empty services-empty.actual

# ---

-- namespace-alpha.yaml --
apiVersion: v1
kind: Namespace
metadata:
  name: ns-alpha
  annotations:
    clustermesh.cilium.io/global: "true"

-- namespace-beta.yaml --
apiVersion: v1
kind: Namespace
metadata:
  name: ns-beta

-- namespace-beta-annotated.yaml --
apiVersion: v1
kind: Namespace
metadata:
  name: ns-beta
  annotations:
    clustermesh.cilium.io/global: "true"

-- service-alpha.yaml --
apiVersion: v1
kind: Service
metadata:
  name: echo-service
  namespace: ns-alpha
  annotations:
    service.cilium.io/global: "true"
    service.cilium.io/shared: "true"
spec:
  clusterIP: 10.96.0.10
  clusterIPs:
  - 10.96.0.10
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: echo
  type: ClusterIP

-- service-beta.yaml --
apiVersion: v1
kind: Service
metadata:
  name: echo-service
  namespace: ns-beta
  annotations:
    service.cilium.io/global: "true"
    service.cilium.io/shared: "true"
spec:
  clusterIP: 10.96.0.20
  clusterIPs:
  - 10.96.0.20
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: echo
  type: ClusterIP

-- endpointslice-alpha.yaml --
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  labels:
    kubernetes.io/service-name: echo-service
  name: echo-service-abc12
  namespace: ns-alpha
addressType: IPv4
endpoints:
- addresses:
  - 10.244.1.10
  conditions:
    ready: true
    serving: true
    terminating: false
  nodeName: worker1
ports:
- name: http
  port: 8080
  protocol: TCP

-- endpointslice-beta.yaml --
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  labels:
    kubernetes.io/service-name: echo-service
  name: echo-service-def34
  namespace: ns-beta
addressType: IPv4
endpoints:
- addresses:
  - 10.244.2.10
  conditions:
    ready: true
    serving: true
    terminating: false
  nodeName: worker2
ports:
- name: http
  port: 8080
  protocol: TCP

-- services-1.expected --
# cilium/state/services/v1/cluster3/ns-alpha/echo-service
{
  "cluster": "cluster3",
  "namespace": "ns-alpha",
  "name": "echo-service",
  "frontends": {
    "10.96.0.10": {
      "http": {
        "Protocol": "TCP",
        "Port": 80
      }
    }
  },
  "backends": {
    "10.244.1.10": {
      "http": {
        "Protocol": "TCP",
        "Port": 8080
      }
    }
  },
  "labels": {},
  "selector": {
    "app": "echo"
  },
  "includeExternal": true,
  "shared": true,
  "clusterID": 3
}
-- services-1+2.expected --
# cilium/state/services/v1/cluster3/ns-alpha/echo-service
{
  "cluster": "cluster3",
  "namespace": "ns-alpha",
  "name": "echo-service",
  "frontends": {
    "10.96.0.10": {
      "http": {
        "Protocol": "TCP",
        "Port": 80
      }
    }
  },
  "backends": {
    "10.244.1.10": {
      "http": {
        "Protocol": "TCP",
        "Port": 8080
      }
    }
  },
  "labels": {},
  "selector": {
    "app": "echo"
  },
  "includeExternal": true,
  "shared": true,
  "clusterID": 3
}
# cilium/state/services/v1/cluster3/ns-beta/echo-service
{
  "cluster": "cluster3",
  "namespace": "ns-beta",
  "name": "echo-service",
  "frontends": {
    "10.96.0.20": {
      "http": {
        "Protocol": "TCP",
        "Port": 80
      }
    }
  },
  "backends": {
    "10.244.2.10": {
      "http": {
        "Protocol": "TCP",
        "Port": 8080
      }
    }
  },
  "labels": {},
  "selector": {
    "app": "echo"
  },
  "includeExternal": true,
  "shared": true,
  "clusterID": 3
}
