// SPDX-License-Identifier: Apache-2.0
// Copyright Authors of Cilium

package graceful_termination

import (
	"testing"

	"github.com/cilium/cilium/pkg/option"
	. "github.com/cilium/cilium/test/controlplane/services"
)

func TestGracefulTermination(t *testing.T) {
	modConfig := func(c *option.DaemonConfig) {
		c.EnableK8sTerminatingEndpoint = true
	}

	// Construct a golden test from the input files generated by 'generate.sh'.
	// Step 1:
	//   state1.yaml: Initial creation of the services and endpoints
	//   lbmap1.golden: Shows graceful-term-svc service with an active backend
	//
	// Step 2:
	//   state2.yaml: Pod is being deleted and endpoint is set to terminating state
	//   lbmap2.golden: The backend state is 'terminating'
	//
	// Step 3:
	//   state3.yaml: Endpoint has now been removed
	//   lbmap3.golden: The graceful-term-svc service no longer has any backeds
	NewGoldenServicesTest(t, "graceful-term-control-plane").Run(t, "1.22", modConfig)
}
